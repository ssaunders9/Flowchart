#!/usr/bin/env python3
"""
Create a single combined HTML file with both interactive and static modes.
Simple approach: Copy both complete implementations and use CSS to toggle visibility.
"""

import re

def extract_styles(html, scope_prefix=''):
    """Extract all <style> content and optionally scope it"""
    styles = re.findall(r'<style>(.*?)</style>', html, re.DOTALL)
    combined_styles = '\n'.join(styles)
    
    if scope_prefix:
        # Scope the CSS to only apply within the scoped container
        # This is a simple approach - prefix most selectors with the scope
        lines = combined_styles.split('\n')
        scoped_lines = []
        for line in lines:
            # Don't scope @media, @keyframes, or comments
            if line.strip().startswith(('@media', '@keyframes', '/*', '*/', '@import')):
                scoped_lines.append(line)
            # Don't scope root-level selectors like :root or html
            elif line.strip().startswith((':root', 'html', '@')):
                scoped_lines.append(line)
            # Scope other selectors
            elif '{' in line and not line.strip().startswith('@'):
                # Extract selector and rules
                parts = line.split('{', 1)
                if len(parts) == 2:
                    selector = parts[0].strip()
                    # Skip if it's already scoped or is a pseudo-element/class only
                    if scope_prefix not in selector and not selector.startswith(('::', ':')):
                        # Handle multiple selectors separated by commas
                        selectors = [s.strip() for s in selector.split(',')]
                        scoped_selectors = []
                        for s in selectors:
                            if s.startswith('body'):
                                # Replace 'body' with the scope
                                scoped_selectors.append(s.replace('body', scope_prefix, 1))
                            elif s == '*':
                                scoped_selectors.append(f'{scope_prefix} {s}')
                            else:
                                scoped_selectors.append(f'{scope_prefix} {s}')
                        scoped_lines.append(', '.join(scoped_selectors) + ' {' + parts[1])
                    else:
                        scoped_lines.append(line)
                else:
                    scoped_lines.append(line)
            else:
                scoped_lines.append(line)
        return '\n'.join(scoped_lines)
    
    return combined_styles

def extract_body(html):
    """Extract body content"""
    match = re.search(r'<body>(.*?)</body>', html, re.DOTALL)
    return match.group(1) if match else ''

def main():
    print("Reading source files...")
    
    # Read both source files
    with open('../Flow.html', 'r', encoding='utf-8') as f:
        flow_html = f.read()
    
    with open('../StaticFlowchart/StaticFlow.html', 'r', encoding='utf-8') as f:
        static_html = f.read()
    
    print("Extracting styles and content...")
    
    # Extract styles from both files with scoping
    flow_styles = extract_styles(flow_html, scope_prefix='.flow-content')
    static_styles = extract_styles(static_html, scope_prefix='.static-content')
    
    # Extract body content from both files
    flow_body = extract_body(flow_html)
    static_body = extract_body(static_html)
    
    print(f"Flow styles: {len(flow_styles)} chars")
    print(f"Static styles: {len(static_styles)} chars")
    print(f"Flow body: {len(flow_body)} chars")
    print(f"Static body: {len(static_body)} chars")
    
    # Wrap scripts in IIFEs to avoid variable conflicts
    def wrap_scripts_in_iife(html_content):
        """Wrap all <script> tags in IIFEs to prevent variable conflicts"""
        import re
        
        def wrap_script(match):
            script_content = match.group(1)
            # Skip if already wrapped or if it's just simple statements
            if script_content.strip().startswith('(function()') or len(script_content.strip()) < 50:
                return match.group(0)
            return f'<script>\n(function() {{\n{script_content}\n}})();\n</script>'
        
        return re.sub(r'<script>(.*?)</script>', wrap_script, html_content, flags=re.DOTALL)
    
    # Remove disclaimer modals from both bodies (we'll add a shared one)
    def remove_disclaimer_modal(html_content):
        """Remove the disclaimer modal div to prevent duplicates"""
        import re
        # Remove the entire disclaimer modal div (with nested divs)
        # Match from <div id="disclaimerModal" to its closing </div>, counting nested divs
        # Simpler approach: match everything from disclaimerModal to the next major element
        result = html_content
        
        # Find the start of the disclaimer modal
        start_match = re.search(r'<div id="disclaimerModal"[^>]*>', result)
        if start_match:
            start_pos = start_match.start()
            # Find the matching closing div by counting nested divs
            pos = start_match.end()
            depth = 1
            while pos < len(result) and depth > 0:
                # Look for next <div or </div
                next_open = result.find('<div', pos)
                next_close = result.find('</div>', pos)
                
                if next_close == -1:
                    break
                    
                if next_open != -1 and next_open < next_close:
                    depth += 1
                    pos = next_open + 4
                else:
                    depth -= 1
                    pos = next_close + 6
            
            # Remove the entire modal section
            if depth == 0:
                result = result[:start_pos] + result[pos:]
        
        return result
    
    # Remove disclaimers
    flow_body_clean = remove_disclaimer_modal(flow_body)
    static_body_clean = remove_disclaimer_modal(static_body)
    
    # Wrap scripts to avoid conflicts
    flow_body_wrapped = wrap_scripts_in_iife(flow_body_clean)
    static_body_wrapped = wrap_scripts_in_iife(static_body_clean)
    
    # Create combined HTML
    combined_html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSU Engineering Curriculum Flowchart - Interactive & Static Modes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    
    <!-- Styles from Flow.html (Interactive Mode) -->
    <style id="flow-styles">
{flow_styles}
    </style>
    
    <!-- Styles from StaticFlow.html (Static Mode) -->
    <style id="static-styles">
{static_styles}
    </style>
    
    <!-- Mode Switcher Styles -->
    <style>
        /* Hidden class for modal */
        .hidden {{
            display: none !important;
        }}
        
        /* Mode switcher bar at the top */
        .mode-switcher-bar {{
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #A60F2D;
            color: white;
            padding: 0.75rem 1.5rem;
            z-index: 100000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }}
        
        .mode-switcher-bar label {{
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }}
        
        .mode-switcher-bar input[type="checkbox"] {{
            width: 20px;
            height: 20px;
            cursor: pointer;
        }}
        
        .mode-indicator {{
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.9em;
        }}
        
        /* Hide/show content based on mode */
        .flow-content {{
            display: block;
        }}
        
        .static-content {{
            display: none;
        }}
        
        body.static-mode .flow-content {{
            display: none;
        }}
        
        body.static-mode .static-content {{
            display: block;
        }}
        
        /* Adjust body padding for switcher bar */
        body {{
            padding-top: 60px;
        }}
        
        /* Hide switcher bar when printing */
        @media print {{
            .mode-switcher-bar {{
                display: none;
            }}
            body {{
                padding-top: 0;
            }}
        }}
    </style>
</head>
<body>
    <!-- Mode Switcher Bar -->
    <div class="mode-switcher-bar">
        <label>
            <input type="checkbox" id="mode-toggle-checkbox">
            <span>üìä Static Mode (Show All Connections)</span>
        </label>
        <div class="mode-indicator">
            <span id="mode-indicator-text">üñ±Ô∏è Interactive Mode Active</span>
        </div>
    </div>
    
    <!-- Shared Disclaimer Modal (works for both modes) -->
    <div id="disclaimerModal" class="modal-overlay" role="dialog" aria-labelledby="disclaimerTitle" aria-modal="true">
        <div class="modal-content">
            <h2 id="disclaimerTitle">‚ö†Ô∏è Important Disclaimer</h2>
            <div class="modal-body">
                <p><strong>This flowchart is for general planning purposes only.</strong></p>
                <p>This tool is designed to help visualize the Chemical Engineering and Bioengineering curriculum at Washington State University. However:</p>
                <ul style="text-align: left; margin: 1rem 0;">
                    <li>Course offerings and requirements may change</li>
                    <li>Prerequisites and co-requisites should be verified with the official WSU catalog</li>
                    <li>Some courses may have additional restrictions not shown here</li>
                    <li>Always consult with your academic advisor for official course planning</li>
                    <li>Individual student circumstances may require different course sequences</li>
                </ul>
                <p><strong>For official information:</strong></p>
                <ul style="text-align: left; margin: 1rem 0;">
                    <li>WSU Catalog: <a href="https://catalog.wsu.edu" target="_blank" rel="noopener">catalog.wsu.edu</a></li>
                    <li>Academic Advising: Contact your assigned advisor</li>
                    <li>Voiland College of Engineering: <a href="https://vcea.wsu.edu" target="_blank" rel="noopener">vcea.wsu.edu</a></li>
                </ul>
            </div>
            <button class="modal-button" onclick="closeSharedDisclaimer()">I Understand - Continue</button>
        </div>
    </div>
    
    <!-- Interactive Mode Content (Flow.html) -->
    <div class="flow-content">
{flow_body_wrapped}
    </div>
    
    <!-- Static Mode Content (StaticFlow.html) -->
    <div class="static-content">
{static_body_wrapped}
    </div>
    
    <!-- Shared Disclaimer Script -->
    <script>
        function closeSharedDisclaimer() {{
            const modal = document.getElementById('disclaimerModal');
            if (modal) {{
                modal.classList.add('hidden');
                try {{
                    localStorage.setItem('flowchartDisclaimerShown', 'true');
                }} catch (e) {{
                    console.warn('Could not save disclaimer state');
                }}
            }}
        }}
        
        function checkAndShowSharedDisclaimer() {{
            let hasSeenDisclaimer = false;
            try {{
                hasSeenDisclaimer = localStorage.getItem('flowchartDisclaimerShown') === 'true';
            }} catch (e) {{
                console.warn('Could not read disclaimer state');
            }}
            
            const modal = document.getElementById('disclaimerModal');
            if (modal && !hasSeenDisclaimer) {{
                modal.classList.remove('hidden');
            }}
        }}
        
        // Show disclaimer on load
        document.addEventListener('DOMContentLoaded', checkAndShowSharedDisclaimer);
        
        // Allow Escape key to close
        document.addEventListener('keydown', function(e) {{
            if (e.key === 'Escape') {{
                const modal = document.getElementById('disclaimerModal');
                if (modal && !modal.classList.contains('hidden')) {{
                    closeSharedDisclaimer();
                }}
            }}
        }});
    </script>
    
    <!-- Mode Switcher Script -->
    <script>
        // Mode switching logic
        const modeToggle = document.getElementById('mode-toggle-checkbox');
        const modeIndicator = document.getElementById('mode-indicator-text');
        
        modeToggle.addEventListener('change', function() {{
            if (this.checked) {{
                document.body.classList.add('static-mode');
                modeIndicator.textContent = 'üìä Static Mode Active';
                
                // Trigger initialization for static mode if needed
                const staticContent = document.querySelector('.static-content');
                if (staticContent) {{
                    // Dispatch a custom event that static mode can listen to
                    window.dispatchEvent(new Event('staticModeActivated'));
                }}
            }} else {{
                document.body.classList.remove('static-mode');
                modeIndicator.textContent = 'üñ±Ô∏è Interactive Mode Active';
                
                // Trigger initialization for interactive mode if needed
                const flowContent = document.querySelector('.flow-content');
                if (flowContent) {{
                    window.dispatchEvent(new Event('interactiveModeActivated'));
                }}
            }}
        }});
    </script>
</body>
</html>"""
    
    # Write combined file
    output_file = 'CombinedFlow_Full.html'
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(combined_html)
    
    print(f"\n‚úÖ Created {output_file}")
    print(f"   Total size: {len(combined_html):,} characters")
    print(f"   Estimated file size: ~{len(combined_html) / 1024:.1f} KB")

if __name__ == '__main__':
    main()
